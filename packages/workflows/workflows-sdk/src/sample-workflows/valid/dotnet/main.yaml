Name: main
SchemaVersion: "1.0"
Triggers:
  - Type: PUSH
    Branches:
      - main
Actions:
  Build_And_Test:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Outputs:
      AutoDiscoverReports:
        IncludePaths:
          - "**/TestResults/*"
        ReportNamePrefix: AutoDiscovered
        Enabled: true
    Configuration:
      Steps:
        - Run: dotnet build Company.HelloWebAPIq4dnv.sln -c Release
        - Run: dotnet test Company.HelloWebAPIq4dnv.sln -c Release --no-build --logger "trx"
  Deploy_To_AWS:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Outputs:
      AutoDiscoverReports:
        ReportNamePrefix: AutoDiscovered
        Enabled: false
    Configuration:
      Steps:
        - Run: yum -y install zip
        - Run: dotnet tool install aws.deploy.tools --global --version 1.*
        - Run: cd src/Company.HelloWebAPIq4dnv
        - Run: dotnet aws deploy --apply ../../.codecatalyst/deployment-settings/prod/apprunner-deployment-settings.json --region us-west-2 --silent
    Environment:
      Name: default_environment
      Connections:
        - Name: canary-target
          Role: canary-admin
    DependsOn:
      - Build_And_Test
