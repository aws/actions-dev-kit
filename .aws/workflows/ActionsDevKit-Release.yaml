Name: ActionsDevKit-Release
SchemaVersion: "1.0"
Triggers:
  - Type: Push
    Branches:
      - main
    FilesChanged:
       - configs/.*\.ts
       - packages/.*/.*\.ts
Actions:
  BuildAssets:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: npm set registry=https://npm.artifacts.service.quokka.codes/AEF-Team/ActionsDevKit/ActionsDevKitPackage/ --userconfig .npmrc
        - Run: npm set //npm.artifacts.service.quokka.codes/AEF-Team/ActionsDevKit/ActionsDevKitPackage/:always-auth=true --userconfig .npmrc
        - Run: npm set //npm.artifacts.service.quokka.codes/AEF-Team/ActionsDevKit/ActionsDevKitPackage/:_authToken=nggujral:${Secrets.NPM_REGISTRY_PAT}
        - Run: npm install --global lerna@5.0.0 yarn@1.22.18
        - Run: lerna --version
        - Run: yarn --version
        - Run: npm --version
        - Run: npm ping -d
        - Run: lerna bootstrap
        - Run: yarn run all
        - Run: sudo yum update -y
        - Run: sudo yum install git -y
        - Run: git config user.email "caws-aef-team-workflow@amazon.com"
        - Run: git config user.name "ActionsDevKitRelease"
        - Run: git remote set-url origin https://saurabhbothra:${Secrets.REPO_PAT}@git.service.quokka.codes/v1/AEF-Team/ActionsDevKit/ActionsDevKit
        - Run: lerna version minor --no-push --yes
        - Run: git status && git add CHANGELOG.md && git commit --amend --no-edit
        - Run: git push origin HEAD:main
        - Run: lerna publish from-git --yes