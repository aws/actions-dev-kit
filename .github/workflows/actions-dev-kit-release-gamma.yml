# This workflow will run tests using node and then publish a package to GitHub Packages when a release is created
# For more information see: https://docs.github.com/en/actions/publishing-packages/publishing-nodejs-packages

name: adk-release-to-gamma

on: [workflow_dispatch]

env:
  GIT_COMMITTER_NAME: ActionsDevKitRelease
  GIT_COMMITTER_EMAIL: cawsactionextensions+adk-release@amazon.com

jobs:
  publish-update-gamma:
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}
      # Setup .npmrc file to publish to npm
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          registry-url: ${{ secrets.CODEARTIFACT_NPM_REGISTRY_GAMMA }}
          scope: '@aws'
      # Install dependencies
      - run: npm install -g npm@6.14.13
      - run: yarn --version
      - run: npm --version

      # Yarn Install
      - run: yarn --immutable-cache

      # one time double bump
      - run: yarn bump

      # Bump all package versions
      - run: yarn bump
      - run: echo "NEW_ADK_RELEASE_VERSION=`jq -r .version packages/adk/adk/package.json`" >> "$GITHUB_ENV"
      - run: echo "NEW_WORKFLOWS_SDK_RELEASE_VERSION=`jq -r .version packages/workflows/workflows-sdk/package.json`" >> "$GITHUB_ENV"
      - run: echo New ADK version - $NEW_ADK_RELEASE_VERSION
      - run: echo New Workflows SDK version - $NEW_WORKFLOWS_SDK_RELEASE_VERSION

      # Build project (also runs tests and packages dist) See packages/adk/adk-utils/.projen/tasks.json
      - run: yarn build

      # Add and show changes
      - run: git add .
      - run: git status

      # Commit changes
      - run: git config --global user.email $GIT_COMMITTER_EMAIL
      - run: git config --global user.name $GIT_COMMITTER_NAME
      - run: echo "RELEASE_COMMIT_MESSAGE='chore(release) release ADK v$NEW_ADK_RELEASE_VERSION and workflows-sdk v$NEW_WORKFLOWS_SDK_RELEASE_VERSION'" >> "$GITHUB_ENV"
      - run: git commit -m "$RELEASE_COMMIT_MESSAGE"
      
      # Configures AWS credentials to access ADK CodeArtifact Gamma repository
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2.0.0
        with:
          role-to-assume: ${{ secrets.PUBLISH_ROLE_TO_ASSUME }}
          aws-region: us-west-2
          role-session-name: adk-githubworkflow
      - run: aws sts get-caller-identity
      - run: aws codeartifact login --region us-west-2 --tool npm --domain ${{ secrets.CODEARTIFACT_DOMAIN }} --domain-owner ${{ secrets.CODEARTIFACT_AWS_ACCOUNT }} --repository ActionsDevKitPackage
      - run: npm config list
      - run: git status
      
      # Publishes ADK packages to CodeArtifact
      - run: yarn npm:publish
